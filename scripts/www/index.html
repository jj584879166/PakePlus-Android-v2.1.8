<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>æˆå‘˜ç…§ç‰‡ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            padding: 15px;
            background: #f8f9fa;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        /* å¯ç¼–è¾‘æ ‡é¢˜æ ·å¼ */
        .title {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-size: 22px;
            font-weight: bold;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
        }
        .title:hover {
            background: #f1f3f5;
        }
        .title-input {
            width: 100%;
            max-width: 500px;
            padding: 10px 15px;
            border: 2px solid #007bff;
            border-radius: 8px;
            font-size: 22px;
            font-weight: bold;
            color: #333;
            text-align: center;
            outline: none;
            background: #fff;
        }
        /* ä¸»åŠŸèƒ½æŒ‰é’®ç»„ */
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 25px;
            justify-content: center;
        }
        .main-btn {
            padding: 12px 18px;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            flex: 1;
            min-width: 100px;
            outline: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .main-btn:nth-child(1) {background: #007bff;}
        .main-btn:nth-child(2) {background: #28a745;}
        .main-btn:nth-child(3) {background: #ffc107;}
        .main-btn:nth-child(4) {background: #dc3545;}
        .main-btn:hover {opacity: 0.9;}
        .main-btn:active {transform: scale(0.98);}
        /* å½•å…¥è¡¨å• */
        .form-box {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            display: none;
        }
        .form-box.show {display: block;}
        .form-item {
            margin-bottom: 20px;
        }
        .form-item label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 16px;
        }
        .form-item input, .form-item select {
            width: 100%;
            padding: 13px 15px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            background: #fff;
        }
        .form-item input:focus, .form-item select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        /* ç…§ç‰‡ä¸Šä¼ åŒºåŸŸ */
        .photo-upload-area {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        #fileInput {
            display: none;
            width: 0;
            height: 0;
        }
        .upload-btn {
            padding: 11px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            outline: none;
            font-size: 15px;
            white-space: nowrap;
        }
        .upload-btn:hover {background: #5c636a;}
        #previewImg {
            width: 110px;
            height: 110px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px dashed #e5e7eb;
            display: none;
            flex-shrink: 0;
        }
        .submit-btn {
            width: 100%;
            padding: 13px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            outline: none;
            box-shadow: 0 2px 5px rgba(40,167,69,0.2);
        }
        .submit-btn:hover {background: #218838;}
        /* æˆå‘˜åˆ—è¡¨ */
        .member-list, .rank-list {
            display: none;
            gap: 15px;
            flex-direction: column;
            margin-bottom: 30px;
        }
        .member-list.show, .rank-list.show {display: flex;}
        .member-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 18px;
            flex-wrap: wrap;
            cursor: pointer;
        }
        .member-item:hover {box-shadow: 0 3px 10px rgba(0,0,0,0.1);}
        .member-avatar {
            width: 90px;
            height: 90px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px solid #f1f3f5;
            flex-shrink: 0;
        }
        .member-info {
            flex: 1;
            min-width: 200px;
        }
        .info-item {
            margin-bottom: 7px;
            font-size: 16px;
            color: #333;
            line-height: 1.4;
        }
        .info-item label {
            font-weight: 500;
            color: #495057;
            margin-right: 8px;
        }
        .info-item span {
            color: #6c757d;
        }
        /* æ˜Ÿæ˜ŸæŒ‰é’® - ç¾åŒ– */
        .score-btn-group {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        .score-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            color: white;
            outline: none;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .add-star {background: #ffc107;}
        .sub-star {background: #6c757d;}
        .score-btn:hover {opacity: 0.9;}
        .score-btn:active {transform: scale(0.95);}
        /* å¼¹çª—æ ·å¼ - æ•´ä½“ä¼˜åŒ– */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        .modal.show {display: flex;}
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
        }
        .modal-title {
            text-align: center;
            margin-bottom: 25px;
            color: #333;
            font-size: 19px;
            font-weight: bold;
        }
        /* å¼¹çª—å†…å¤´åƒ */
        #modalAvatar {
            width: 130px;
            height: 130px;
            border-radius: 10px;
            object-fit: cover;
            margin: 0 auto 20px;
            display: block;
            border: 2px solid #f1f3f5;
            cursor: pointer;
        }
        #modalAvatar:hover {border-color: #007bff;}
        #modalFileInput {display: none;}
        /* å¼¹çª—å†…æˆå‘˜ä¿¡æ¯ */
        .modal-member-info {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        .modal-info-item {
            margin-bottom: 10px;
            font-size: 16px;
            line-height: 1.5;
        }
        .modal-info-item label {
            font-weight: 500;
            color: #495057;
            min-width: 60px;
            display: inline-block;
        }
        .modal-info-item span {
            color: #333;
        }
        /* å¤‡æ³¨æ¡† - æ”¾å¤§+è‡ªåŠ¨æ¢è¡Œ */
        .modal-form-item textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            min-height: 120px;
            resize: vertical;
            font-size: 16px;
            outline: none;
            margin-bottom: 20px;
            line-height: 1.5;
            word-wrap: break-word;
            word-break: break-all;
        }
        .modal-form-item textarea:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        /* çˆ±å¿ƒæŒ‰é’® - ç¾åŒ–+å¤§å°ºå¯¸ */
        .heart-btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 25px;
        }
        .heart-btn {
            padding: 10px 25px;
            background: #e83e8c;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            outline: none;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 3px 8px rgba(232,62,140,0.2);
        }
        .heart-btn:hover {background: #d63384;}
        .heart-btn:active {transform: scale(0.95);}
        /* å¼¹çª—æŒ‰é’®ç»„ - æ–°å¢åˆ é™¤æŒ‰é’® */
        .modal-btn-group {
            display: flex;
            gap: 12px;
        }
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            color: white;
            font-size: 16px;
            outline: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .save-btn {background: #28a745;}
        .del-btn {background: #dc3545;}
        .close-btn {background: #6c757d;}
        .modal-btn:hover {opacity: 0.9;}
        .modal-btn:active {transform: scale(0.98);}
        /* æ’è¡Œæ¦œ */
        .rank-list .rank-filter {
            background: white;
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        .rank-filter label {color: #495057; font-size: 16px;}
        .rank-filter select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            outline: none;
            font-size: 16px;
            min-width: 130px;
        }
        .rank-filter select:focus {border-color: #007bff;}
        .rank-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 18px;
            flex-wrap: wrap;
        }
        .rank-avatar {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            object-fit: cover;
            border: 2px solid #f1f3f5;
            flex-shrink: 0;
        }
        /* éšè—è®¾ç½®å¼¹çª— */
        .setting-item {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 16px;
        }
        .setting-item input {
            width: 18px;
            height: 18px;
            outline: none;
            cursor: pointer;
            accent-color: #007bff;
        }
        /* ç©ºçŠ¶æ€æç¤º */
        .empty-tip {
            text-align:center; 
            padding: 40px 20px; 
            background:#fff; 
            border-radius:12px; 
            color:#6c757d;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¯åŒå‡»ç¼–è¾‘çš„æ ‡é¢˜ -->
        <h1 class="title" id="editTitle">æˆå‘˜ç…§ç‰‡ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ</h1>
        
        <!-- æ ¸å¿ƒåŠŸèƒ½æŒ‰é’® -->
        <div class="btn-group">
            <button class="main-btn" id="addMemberBtn">å½•å…¥æˆå‘˜</button>
            <button class="main-btn" id="memberListBtn">æˆå‘˜åˆ—è¡¨</button>
            <button class="main-btn" id="rankBtn">æ’è¡Œæ¦œ</button>
            <button class="main-btn" id="hideSettingBtn">éšè—è®¾ç½®</button>
        </div>

        <!-- å½•å…¥æˆå‘˜è¡¨å• -->
        <div class="form-box" id="addForm">
            <div class="form-item">
                <label>æˆå‘˜ç…§ç‰‡</label>
                <div class="photo-upload-area">
                    <input type="file" id="fileInput" accept="image/*" capture="camera" multiple="false">
                    <button class="upload-btn" id="takePhotoBtn">ğŸ“· æ‹ç…§ä¸Šä¼ </button>
                    <button class="upload-btn" id="choosePhotoBtn">ğŸ–¼ï¸ ç›¸å†Œé€‰æ‹©</button>
                    <img src="" alt="ç…§ç‰‡é¢„è§ˆ" id="previewImg">
                </div>
            </div>
            <div class="form-item">
                <label>å§“å</label>
                <input type="text" id="userName" placeholder="è¯·è¾“å…¥æˆå‘˜å§“å" autocomplete="off">
            </div>
            <div class="form-item">
                <label>æ€§åˆ«</label>
                <select id="userGender">
                    <option value="ç”·">ç”·</option>
                    <option value="å¥³">å¥³</option>
                </select>
            </div>
            <div class="form-item">
                <label>ç­çº§</label>
                <input type="text" id="userClass" placeholder="è¯·è¾“å…¥ç­çº§ï¼Œå¦‚ï¼šå¤§ä¸€ç­/ä¸‰å¹´çº§2ç­" autocomplete="off">
            </div>
            <button class="submit-btn" id="saveMemberBtn">âœ… ä¿å­˜æˆå‘˜ä¿¡æ¯</button>
        </div>

        <!-- æˆå‘˜åˆ—è¡¨ -->
        <div class="member-list" id="memberListBox"></div>

        <!-- æ’è¡Œæ¦œ -->
        <div class="rank-list" id="rankBox">
            <div class="rank-filter">
                <label>æ’åºä¾æ®ï¼š</label>
                <select id="sortType">
                    <option value="star">â­ æ˜Ÿæ˜Ÿæ•°é‡</option>
                    <option value="heart">â¤ï¸ çˆ±å¿ƒæ•°é‡</option>
                </select>
                <label>æ’åºæ–¹å¼ï¼š</label>
                <select id="sortOrder">
                    <option value="desc">ä»å¤šåˆ°å°‘</option>
                    <option value="asc">ä»å°‘åˆ°å¤š</option>
                </select>
            </div>
            <div id="rankListContent"></div>
        </div>

        <!-- æˆå‘˜è¯¦æƒ…å¼¹çª—ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼šæ˜¾ç¤ºå…¨ä¿¡æ¯+å¤§å¤‡æ³¨+æ¢ç…§ç‰‡+åˆ é™¤ï¼‰ -->
        <div class="modal" id="memberModal">
            <div class="modal-content">
                <h3 class="modal-title">æˆå‘˜è¯¦æƒ…ç¼–è¾‘</h3>
                <img src="" alt="ç‚¹å‡»æ›´æ¢ç…§ç‰‡" id="modalAvatar">
                <input type="file" id="modalFileInput" accept="image/*" capture="camera" multiple="false">
                
                <!-- å¼¹çª—å†…æ˜¾ç¤ºå®Œæ•´æˆå‘˜ä¿¡æ¯ -->
                <div class="modal-member-info">
                    <div class="modal-info-item"><label>å§“åï¼š</label><span id="modalName"></span></div>
                    <div class="modal-info-item"><label>æ€§åˆ«ï¼š</label><span id="modalGender"></span></div>
                    <div class="modal-info-item"><label>ç­çº§ï¼š</label><span id="modalClass"></span></div>
                    <div class="modal-info-item"><label>æ˜Ÿæ˜Ÿï¼š</label><span id="modalStar">0</span> â­</div>
                    <div class="modal-info-item"><label>çˆ±å¿ƒï¼š</label><span id="modalHeart">0</span> â¤ï¸</div>
                </div>

                <!-- æ”¾å¤§ç‰ˆå¤‡æ³¨æ¡† -->
                <div class="modal-form-item">
                    <textarea id="memberRemark" placeholder="è¯·è¾“å…¥æˆå‘˜å¤‡æ³¨ä¿¡æ¯ï¼Œæ”¯æŒè‡ªåŠ¨æ¢è¡Œ..."></textarea>
                </div>

                <!-- ç¾åŒ–ç‰ˆçˆ±å¿ƒæŒ‰é’® -->
                <div class="heart-btn-group">
                    <button class="heart-btn" id="addHeartBtn">â¤ï¸ çˆ±å¿ƒ+1</button>
                    <button class="heart-btn" id="subHeartBtn">â¤ï¸ çˆ±å¿ƒ-1</button>
                </div>

                <!-- å¼¹çª—æŒ‰é’®ç»„ï¼šä¿å­˜+åˆ é™¤+å…³é—­ -->
                <div class="modal-btn-group">
                    <button class="modal-btn save-btn" id="saveModalBtn">âœ… ä¿å­˜ä¿®æ”¹</button>
                    <button class="modal-btn del-btn" id="deleteMemberBtn">ğŸ—‘ï¸ åˆ é™¤æˆå‘˜</button>
                    <button class="modal-btn close-btn" id="closeModalBtn">âŒ å…³é—­</button>
                </div>
            </div>
        </div>

        <!-- éšè—è®¾ç½®å¼¹çª— -->
        <div class="modal" id="hideSettingModal">
            <div class="modal-content">
                <h3 class="modal-title">ä¿¡æ¯æ˜¾ç¤ºè®¾ç½®</h3>
                <div class="setting-item">
                    <input type="checkbox" id="hideName" checked>
                    <label>æ˜¾ç¤ºå§“å</label>
                </div>
                <div class="setting-item">
                    <input type="checkbox" id="hideGender" checked>
                    <label>æ˜¾ç¤ºæ€§åˆ«</label>
                </div>
                <div class="setting-item">
                    <input type="checkbox" id="hideClass" checked>
                    <label>æ˜¾ç¤ºç­çº§</label>
                </div>
                <div class="setting-item">
                    <input type="checkbox" id="hideStar" checked>
                    <label>æ˜¾ç¤ºâ­ æ˜Ÿæ˜Ÿ</label>
                </div>
                <div class="setting-item">
                    <input type="checkbox" id="hideHeart" checked>
                    <label>æ˜¾ç¤ºâ¤ï¸ çˆ±å¿ƒ</label>
                </div>
                <div class="modal-btn-group" style="margin-top: 10px;">
                    <button class="modal-btn save-btn" id="saveSettingBtn">âœ… ä¿å­˜è®¾ç½®</button>
                    <button class="modal-btn close-btn" id="closeSettingBtn">âŒ å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¼å®¹ç§»åŠ¨ç«¯/PCç«¯
        const isMobile = /Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
        const clickEvent = 'click';
        // ç¦æ­¢é»˜è®¤è¡Œä¸ºé¿å…å†²çª
        document.addEventListener('dblclick', e => e.preventDefault(), {passive: false});

        // å…¨å±€æ ¸å¿ƒå˜é‡ - æœ¬åœ°å­˜å‚¨é”®åå›ºå®šï¼Œç¡®ä¿æ°¸ä¹…ä¿å­˜
        const STORAGE_KEY_MEMBER = 'MEMBER_LIST_2025';
        const STORAGE_KEY_SETTING = 'HIDE_SETTING_2025';
        const STORAGE_KEY_TITLE = 'SYSTEM_TITLE_2025'; // æ–°å¢æ ‡é¢˜å­˜å‚¨é”®
        const FILE_INPUT = document.getElementById('fileInput');
        const PREVIEW_IMG = document.getElementById('previewImg');
        const MODAL_FILE_INPUT = document.getElementById('modalFileInput');
        const editTitle = document.getElementById('editTitle');
        let currentMemberId = null; // å½“å‰æ“ä½œæˆå‘˜ID
        // æœ¬åœ°å­˜å‚¨æ•°æ®ï¼ˆæ°¸ä¹…ä¿å­˜ï¼Œä¿®å¤è¯»å–é€»è¾‘ï¼‰
        let memberList = JSON.parse(localStorage.getItem(STORAGE_KEY_MEMBER) || '[]');
        let hideSetting = JSON.parse(localStorage.getItem(STORAGE_KEY_SETTING) || '{"hideName":true,"hideGender":true,"hideClass":true,"hideStar":true,"hideHeart":true}');
        let systemTitle = localStorage.getItem(STORAGE_KEY_TITLE) || 'æˆå‘˜ç…§ç‰‡ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ'; // è¯»å–è‡ªå®šä¹‰æ ‡é¢˜

        // é¡µé¢åˆå§‹åŒ– - ä¼˜å…ˆè¯»å–æœ¬åœ°å­˜å‚¨ï¼Œç¡®ä¿é‡å¯åæ•°æ®å­˜åœ¨
        window.onload = function() {
            // å¼ºåˆ¶åˆå§‹åŒ–æœ¬åœ°å­˜å‚¨ï¼ˆé˜²æ­¢é”®åä¸¢å¤±ï¼‰
            if (!localStorage.getItem(STORAGE_KEY_MEMBER)) localStorage.setItem(STORAGE_KEY_MEMBER, '[]');
            if (!localStorage.getItem(STORAGE_KEY_SETTING)) localStorage.setItem(STORAGE_KEY_SETTING, '{"hideName":true,"hideGender":true,"hideClass":true,"hideStar":true,"hideHeart":true}');
            if (!localStorage.getItem(STORAGE_KEY_TITLE)) localStorage.setItem(STORAGE_KEY_TITLE, systemTitle);
            // åˆå§‹åŒ–æ ‡é¢˜
            editTitle.innerText = systemTitle;
            // åˆå§‹åŒ–éšè—è®¾ç½®å‹¾é€‰çŠ¶æ€
            document.getElementById('hideName').checked = hideSetting.hideName;
            document.getElementById('hideGender').checked = hideSetting.hideGender;
            document.getElementById('hideClass').checked = hideSetting.hideClass;
            document.getElementById('hideStar').checked = hideSetting.hideStar;
            document.getElementById('hideHeart').checked = hideSetting.hideHeart;
            // æ’è¡Œæ¦œæ’åºäº‹ä»¶
            document.getElementById('sortType').onchange = renderRankList;
            document.getElementById('sortOrder').onchange = renderRankList;
            // ç»‘å®šæ‰€æœ‰äº‹ä»¶
            bindAllEvents();
            // ç»‘å®šæ ‡é¢˜åŒå‡»ç¼–è¾‘äº‹ä»¶
            bindTitleEditEvent();
        };

        // ç»‘å®šæ‰€æœ‰æŒ‰é’®äº‹ä»¶
        function bindAllEvents() {
            /********************* ä¸»åŠŸèƒ½æŒ‰é’® *********************/
            document.getElementById('addMemberBtn').addEventListener(clickEvent, () => {
                hideAllModule();
                document.getElementById('addForm').classList.add('show');
                resetForm();
            });
            document.getElementById('memberListBtn').addEventListener(clickEvent, () => {
                hideAllModule();
                document.getElementById('memberListBox').classList.add('show');
                renderMemberList();
            });
            document.getElementById('rankBtn').addEventListener(clickEvent, () => {
                hideAllModule();
                document.getElementById('rankBox').classList.add('show');
                renderRankList();
            });
            document.getElementById('hideSettingBtn').addEventListener(clickEvent, () => {
                document.getElementById('hideSettingModal').classList.add('show');
            });

            /********************* ç…§ç‰‡ä¸Šä¼  *********************/
            // æ‹ç…§ä¸Šä¼ 
            document.getElementById('takePhotoBtn').addEventListener(clickEvent, () => {
                FILE_INPUT.value = '';
                FILE_INPUT.setAttribute('capture', 'camera');
                FILE_INPUT.click();
            });
            // ç›¸å†Œé€‰æ‹©
            document.getElementById('choosePhotoBtn').addEventListener(clickEvent, () => {
                FILE_INPUT.value = '';
                FILE_INPUT.removeAttribute('capture');
                FILE_INPUT.click();
            });
            // å½•å…¥é¡µç…§ç‰‡é¢„è§ˆ
            FILE_INPUT.addEventListener('change', photoPreview);
            // å¼¹çª—å†…ç…§ç‰‡æ›´æ¢
            MODAL_FILE_INPUT.addEventListener('change', modalPhotoChange);
            // å¼¹çª—å¤´åƒç‚¹å‡»æ¢ç…§ç‰‡
            document.getElementById('modalAvatar').addEventListener(clickEvent, () => {
                MODAL_FILE_INPUT.value = '';
                MODAL_FILE_INPUT.click();
            });

            /********************* å½•å…¥è¡¨å• - æ–°å¢äºŒæ¬¡ç¡®è®¤ *********************/
            document.getElementById('saveMemberBtn').addEventListener(clickEvent, () => {
                // å…ˆåšè¡¨å•åŸºç¡€æ ¡éªŒ
                const name = document.getElementById('userName').value.trim();
                const className = document.getElementById('userClass').value.trim();
                const photo = PREVIEW_IMG.src;
                if (!name) {alert('è¯·è¾“å…¥æˆå‘˜å§“åï¼'); return;}
                if (!className) {alert('è¯·è¾“å…¥ç­çº§ä¿¡æ¯ï¼'); return;}
                if (!photo || photo === '') {alert('è¯·å…ˆä¸Šä¼ æˆå‘˜ç…§ç‰‡ï¼'); return;}
                // äºŒæ¬¡ç¡®è®¤æ˜¯å¦ä¿å­˜
                const isConfirm = confirm('ğŸ“ ç¡®è®¤ä¿å­˜è¯¥æˆå‘˜ä¿¡æ¯å—ï¼Ÿ\nä¿å­˜åå°†æ°¸ä¹…å­˜å‚¨åˆ°æœ¬åœ°ï¼Œå¯åœ¨æˆå‘˜åˆ—è¡¨æŸ¥çœ‹ï¼');
                if (isConfirm) {
                    saveMemberInfo(); // ç¡®è®¤åæ‰§è¡Œä¿å­˜
                }
            });

            /********************* æˆå‘˜è¯¦æƒ…å¼¹çª— *********************/
            document.getElementById('closeModalBtn').addEventListener(clickEvent, () => {
                document.getElementById('memberModal').classList.remove('show');
                currentMemberId = null;
            });
            document.getElementById('saveModalBtn').addEventListener(clickEvent, saveModalInfo);
            document.getElementById('addHeartBtn').addEventListener(clickEvent, () => changeHeart(1));
            document.getElementById('subHeartBtn').addEventListener(clickEvent, () => changeHeart(-1));
            // åˆ é™¤æˆå‘˜åŠŸèƒ½ - åŒé‡ç¡®è®¤
            document.getElementById('deleteMemberBtn').addEventListener(clickEvent, deleteMember);

            /********************* éšè—è®¾ç½®å¼¹çª— *********************/
            document.getElementById('saveSettingBtn').addEventListener(clickEvent, saveHideSetting);
            document.getElementById('closeSettingBtn').addEventListener(clickEvent, () => {
                document.getElementById('hideSettingModal').classList.remove('show');
            });
        }

        /********************* æ–°å¢ï¼šæ ‡é¢˜åŒå‡»ç¼–è¾‘äº‹ä»¶ *********************/
        function bindTitleEditEvent() {
            // åŒå‡»æ ‡é¢˜å˜ä¸ºè¾“å…¥æ¡†
            editTitle.addEventListener('dblclick', () => {
                const currentText = editTitle.innerText;
                // åˆ›å»ºè¾“å…¥æ¡†
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'title-input';
                input.value = currentText;
                // æ›¿æ¢æ ‡é¢˜ä¸ºè¾“å…¥æ¡†
                editTitle.parentNode.replaceChild(input, editTitle);
                // è¾“å…¥æ¡†è‡ªåŠ¨è·å–ç„¦ç‚¹
                input.focus();
                // ç‚¹å‡»ç©ºç™½å¤„ä¿å­˜ä¿®æ”¹
                document.addEventListener('click', (e) => {
                    if (e.target !== input) {
                        saveTitle(input.value);
                    }
                });
                // æŒ‰å›è½¦é”®ä¿å­˜ä¿®æ”¹
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        saveTitle(input.value);
                    }
                });
            });
        }
        // ä¿å­˜è‡ªå®šä¹‰æ ‡é¢˜ï¼ˆåŒæ­¥æœ¬åœ°å­˜å‚¨ï¼‰
        function saveTitle(newTitle) {
            if (!newTitle || newTitle.trim() === '') {
                newTitle = 'æˆå‘˜ç…§ç‰‡ç§¯åˆ†ç®¡ç†ç³»ç»Ÿ'; // ç©ºå€¼é»˜è®¤æ ‡é¢˜
            }
            systemTitle = newTitle.trim();
            // æ›¿æ¢è¾“å…¥æ¡†ä¸ºæ ‡é¢˜
            editTitle.innerText = systemTitle;
            const input = document.querySelector('.title-input');
            if (input) {
                input.parentNode.replaceChild(editTitle, input);
            }
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œæ°¸ä¹…ç”Ÿæ•ˆ
            localStorage.setItem(STORAGE_KEY_TITLE, systemTitle);
            // é‡æ–°ç»‘å®šåŒå‡»äº‹ä»¶
            bindTitleEditEvent();
        }

        /********************* æ ¸å¿ƒé€šç”¨æ–¹æ³• - ä¿®å¤æœ¬åœ°å­˜å‚¨ *********************/
        // éšè—æ‰€æœ‰æ¨¡å—
        function hideAllModule() {
            document.getElementById('addForm').classList.remove('show');
            document.getElementById('memberListBox').classList.remove('show');
            document.getElementById('rankBox').classList.remove('show');
        }
        // æœ¬åœ°å­˜å‚¨ä¿å­˜ - å›ºå®šé”®åï¼Œå¼ºåˆ¶åºåˆ—åŒ–ï¼Œç¡®ä¿æ°¸ä¹…ä¿å­˜
        function saveToLocal() {
            localStorage.setItem(STORAGE_KEY_MEMBER, JSON.stringify(memberList));
            localStorage.setItem(STORAGE_KEY_SETTING, JSON.stringify(hideSetting));
            // å¼ºåˆ¶åˆ·æ–°æœ¬åœ°å­˜å‚¨ï¼ˆè§£å†³éƒ¨åˆ†æµè§ˆå™¨ç¼“å­˜é—®é¢˜ï¼‰
            localStorage.getItem(STORAGE_KEY_MEMBER);
            localStorage.getItem(STORAGE_KEY_SETTING);
        }

        /********************* ç…§ç‰‡ä¸Šä¼ ç›¸å…³ *********************/
        // å½•å…¥é¡µç…§ç‰‡é¢„è§ˆ
        function photoPreview(e) {
            const file = e.target.files[0];
            if (!file || !file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ï¼');
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                PREVIEW_IMG.src = e.target.result;
                PREVIEW_IMG.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
        // å¼¹çª—å†…æ›´æ¢ç…§ç‰‡
        function modalPhotoChange(e) {
            const file = e.target.files[0];
            if (!file || !file.type.startsWith('image/') || !currentMemberId) {
                alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ï¼');
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const member = memberList.find(item => item.id === currentMemberId);
                if (member) {
                    member.photo = e.target.result;
                    document.getElementById('modalAvatar').src = e.target.result;
                    saveToLocal(); // ç«‹å³ä¿å­˜
                    renderMemberList();
                    renderRankList();
                    alert('ç…§ç‰‡æ›´æ¢æˆåŠŸï¼');
                }
            };
            reader.readAsDataURL(file);
        }

        /********************* å½•å…¥æˆå‘˜ç›¸å…³ *********************/
        // ä¿å­˜æˆå‘˜ä¿¡æ¯ - ä¿®å¤ä¿å­˜åç«‹å³åŒæ­¥æœ¬åœ°å­˜å‚¨
        function saveMemberInfo() {
            const name = document.getElementById('userName').value.trim();
            const gender = document.getElementById('userGender').value;
            const className = document.getElementById('userClass').value.trim();
            const photo = PREVIEW_IMG.src;

            // æ„é€ æˆå‘˜æ•°æ®
            const newMember = {
                id: Date.now(), // æ—¶é—´æˆ³ä½œä¸ºå”¯ä¸€ID
                name: name,
                gender: gender,
                className: className,
                photo: photo,
                star: 0,
                heart: 0,
                remark: ''
            };

            // åŠ å…¥åˆ—è¡¨å¹¶ç«‹å³ä¿å­˜ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
            memberList.push(newMember);
            saveToLocal(); // å¼ºåˆ¶ä¿å­˜åˆ°æœ¬åœ°
            alert('âœ… æˆå‘˜ä¿¡æ¯ä¿å­˜æˆåŠŸï¼ï¼ˆå·²æ°¸ä¹…å­˜å‚¨ï¼‰');
            resetForm();
            hideAllModule();
        }
        // é‡ç½®å½•å…¥è¡¨å•
        function resetForm() {
            document.getElementById('userName').value = '';
            document.getElementById('userGender').selectedIndex = 0;
            document.getElementById('userClass').value = '';
            FILE_INPUT.value = '';
            PREVIEW_IMG.src = '';
            PREVIEW_IMG.style.display = 'none';
        }

        /********************* æˆå‘˜åˆ—è¡¨ç›¸å…³ *********************/
        // æ¸²æŸ“æˆå‘˜åˆ—è¡¨ - æ¯æ¬¡æ¸²æŸ“å‰é‡æ–°è¯»å–æœ¬åœ°å­˜å‚¨
        function renderMemberList() {
            // é‡æ–°è¯»å–æœ¬åœ°å­˜å‚¨ï¼Œç¡®ä¿æ•°æ®æœ€æ–°
            memberList = JSON.parse(localStorage.getItem(STORAGE_KEY_MEMBER) || '[]');
            const listBox = document.getElementById('memberListBox');
            listBox.innerHTML = '';

            // æ— æˆå‘˜æç¤º
            if (memberList.length === 0) {
                listBox.innerHTML = `<div class="empty-tip">æš‚æ— æˆå‘˜ä¿¡æ¯<br>ç‚¹å‡»ã€å½•å…¥æˆå‘˜ã€‘æ·»åŠ å§ï¼</div>`;
                return;
            }

            // éå†æ¸²æŸ“æ¯ä¸ªæˆå‘˜
            memberList.forEach(member => {
                // æ ¹æ®è®¾ç½®åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºä¿¡æ¯
                let nameHtml = hideSetting.hideName ? `<div class="info-item"><label>å§“å</label><span>${member.name}</span></div>` : '';
                let genderHtml = hideSetting.hideGender ? `<div class="info-item"><label>æ€§åˆ«</label><span>${member.gender}</span></div>` : '';
                let classHtml = hideSetting.hideClass ? `<div class="info-item"><label>ç­çº§</label><span>${member.className}</span></div>` : '';
                let starHtml = hideSetting.hideStar ? `<div class="info-item"><label>æ˜Ÿæ˜Ÿ</label><span>${member.star}</span> â­</div>` : '';
                let heartHtml = hideSetting.hideHeart ? `<div class="info-item"><label>çˆ±å¿ƒ</label><span>${member.heart}</span> â¤ï¸</div>` : '';
                // æ˜Ÿæ˜ŸæŒ‰é’®ï¼ˆä»…æ˜¾ç¤ºæ˜Ÿæ˜Ÿæ—¶å±•ç¤ºï¼‰
                let starBtnHtml = hideSetting.hideStar ? `
                    <div class="score-btn-group">
                        <button class="score-btn add-star" data-id="${member.id}">+ â­ æ˜Ÿæ˜Ÿ</button>
                        <button class="score-btn sub-star" data-id="${member.id}">- â­ æ˜Ÿæ˜Ÿ</button>
                    </div>
                ` : '';

                // åˆ›å»ºæˆå‘˜é¡¹
                const item = document.createElement('div');
                item.className = 'member-item';
                item.dataset.id = member.id;
                item.innerHTML = `
                    <img src="${member.photo}" alt="${member.name}" class="member-avatar" data-id="${member.id}">
                    <div class="member-info" data-id="${member.id}">
                        ${nameHtml}
                        ${genderHtml}
                        ${classHtml}
                        ${starHtml}
                        ${heartHtml}
                        ${starBtnHtml}
                    </div>
                `;
                listBox.appendChild(item);

                // ç‚¹å‡»æˆå‘˜é¡¹ï¼ˆç…§ç‰‡/å§“åéƒ½å¯ï¼‰æ‰“å¼€å¼¹çª—
                item.addEventListener(clickEvent, () => openMemberModal(member.id));
            });

            // ç»‘å®šæ˜Ÿæ˜ŸæŒ‰é’®å•ç‹¬äº‹ä»¶ï¼ˆé˜»æ­¢å†’æ³¡ï¼‰
            bindStarBtnEvent();
        }
        // ç»‘å®šæ˜Ÿæ˜Ÿå¢å‡æŒ‰é’®äº‹ä»¶
        function bindStarBtnEvent() {
            document.querySelectorAll('.score-btn').forEach(btn => {
                btn.addEventListener(clickEvent, (e) => {
                    e.stopPropagation(); // é˜»æ­¢è§¦å‘å¼¹çª—
                    const id = Number(btn.dataset.id);
                    const type = btn.classList.contains('add-star') ? 1 : -1;
                    changeStar(id, type);
                });
            });
        }
        // æ˜Ÿæ˜Ÿå¢å‡ - æ“ä½œåç«‹å³ä¿å­˜
        function changeStar(id, type) {
            const member = memberList.find(item => item.id === id);
            if (!member) return;
            if (type === 1) {
                member.star++;
                alert(`æ˜Ÿæ˜Ÿ+1ï¼Œå½“å‰ï¼š${member.star}é¢—`);
            } else {
                if (member.star <= 0) {
                    alert('æ˜Ÿæ˜Ÿæ•°é‡ä¸èƒ½å°äº0ï¼');
                    return;
                }
                member.star--;
                alert(`æ˜Ÿæ˜Ÿ-1ï¼Œå½“å‰ï¼š${member.star}é¢—`);
            }
            saveToLocal(); // ç«‹å³ä¿å­˜
            renderMemberList();
            renderRankList();
        }

        /********************* æˆå‘˜è¯¦æƒ…å¼¹çª— *********************/
        // æ‰“å¼€æˆå‘˜è¯¦æƒ…å¼¹çª—
        function openMemberModal(id) {
            currentMemberId = id;
            const member = memberList.find(item => item.id === id);
            if (!member) return;

            // å¡«å……å¼¹çª—æ•°æ®
            document.getElementById('modalAvatar').src = member.photo;
            document.getElementById('modalName').innerText = member.name;
            document.getElementById('modalGender').innerText = member.gender;
            document.getElementById('modalClass').innerText = member.className;
            document.getElementById('modalStar').innerText = member.star;
            document.getElementById('modalHeart').innerText = member.heart;
            document.getElementById('memberRemark').value = member.remark || '';

            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('memberModal').classList.add('show');
        }
        // çˆ±å¿ƒå¢å‡ - æ“ä½œåç«‹å³ä¿å­˜
        function changeHeart(type) {
            if (!currentMemberId) return;
            const member = memberList.find(item => item.id === currentMemberId);
            if (!member) return;

            if (type === 1) {
                member.heart++;
                document.getElementById('modalHeart').innerText = member.heart;
                alert(`çˆ±å¿ƒ+1ï¼Œå½“å‰ï¼š${member.heart}é¢—`);
            } else {
                if (member.heart <= 0) {
                    alert('çˆ±å¿ƒæ•°é‡ä¸èƒ½å°äº0ï¼');
                    return;
                }
                member.heart--;
                document.getElementById('modalHeart').innerText = member.heart;
                alert(`çˆ±å¿ƒ-1ï¼Œå½“å‰ï¼š${member.heart}é¢—`);
            }
            saveToLocal(); // ç«‹å³ä¿å­˜
            renderMemberList();
            renderRankList();
        }
        // ä¿å­˜å¼¹çª—ä¿®æ”¹ - ç«‹å³åŒæ­¥æœ¬åœ°å­˜å‚¨
        function saveModalInfo() {
            if (!currentMemberId) return;
            const member = memberList.find(item => item.id === currentMemberId);
            if (!member) return;

            // ä¿å­˜å¤‡æ³¨
            member.remark = document.getElementById('memberRemark').value.trim();
            saveToLocal(); // ç«‹å³ä¿å­˜
            renderMemberList();
            document.getElementById('memberModal').classList.remove('show');
            currentMemberId = null;
            alert('âœ… æˆå‘˜ä¿¡æ¯ä¿®æ”¹ä¿å­˜æˆåŠŸï¼ï¼ˆå·²æ°¸ä¹…å­˜å‚¨ï¼‰');
        }
        // åˆ é™¤æˆå‘˜ - åŒé‡ç¡®è®¤+å½»åº•åˆ é™¤+ç«‹å³ä¿å­˜
        function deleteMember() {
            if (!currentMemberId) return;
            // ä¸€çº§è­¦å‘Šç¡®è®¤
            const firstConfirm = confirm('âš ï¸ è­¦å‘Šï¼\nå³å°†åˆ é™¤è¯¥æˆå‘˜æ‰€æœ‰ä¿¡æ¯ï¼\nåˆ é™¤åæ•°æ®å°†æ°¸ä¹…æ— æ³•æ¢å¤ï¼\n\næ˜¯å¦ç»§ç»­ï¼Ÿ');
            if (!firstConfirm) return;
            // äºŒçº§ç²¾å‡†ç¡®è®¤
            const secondConfirm = confirm('âœ… å†æ¬¡ç¡®è®¤ï¼\nç¡®å®šè¦åˆ é™¤ã€' + document.getElementById('modalName').innerText + 'ã€‘çš„æ‰€æœ‰ä¿¡æ¯å—ï¼Ÿ\nç‚¹å‡»"ç¡®å®š"å°†å½»åº•åˆ é™¤ï¼');
            if (!secondConfirm) return;

            // å½»åº•è¿‡æ»¤åˆ é™¤æˆå‘˜æ•°æ®
            memberList = memberList.filter(item => item.id !== currentMemberId);
            saveToLocal(); // ç«‹å³ä¿å­˜ï¼Œæ¸…é™¤æœ¬åœ°æ•°æ®
            renderMemberList();
            renderRankList();
            document.getElementById('memberModal').classList.remove('show');
            currentMemberId = null;
            alert('âœ… æˆå‘˜å·²å½»åº•åˆ é™¤ï¼\næ‰€æœ‰ç›¸å…³æ•°æ®å·²æ¸…é™¤ï¼');
        }

        /********************* æ’è¡Œæ¦œç›¸å…³ *********************/
        // æ¸²æŸ“æ’è¡Œæ¦œ - æ¸²æŸ“å‰é‡æ–°è¯»å–æœ¬åœ°å­˜å‚¨
        function renderRankList() {
            // é‡æ–°è¯»å–æœ¬åœ°å­˜å‚¨ï¼Œç¡®ä¿æ•°æ®æœ€æ–°
            memberList = JSON.parse(localStorage.getItem(STORAGE_KEY_MEMBER) || '[]');
            const rankContent = document.getElementById('rankListContent');
            rankContent.innerHTML = '';
            const sortType = document.getElementById('sortType').value; // star/heart
            const sortOrder = document.getElementById('sortOrder').value; // desc/asc

            // æ— æˆå‘˜æç¤º
            if (memberList.length === 0) {
                rankContent.innerHTML = `<div class="empty-tip">æš‚æ— æˆå‘˜ä¿¡æ¯<br>æ— æ³•ç”Ÿæˆæ’è¡Œæ¦œï¼</div>`;
                return;
            }

            // æ·±æ‹·è´å¹¶æ’åº
            let sortedList = JSON.parse(JSON.stringify(memberList));
            sortedList.sort((a, b) => {
                return sortOrder === 'desc' ? b[sortType] - a[sortType] : a[sortType] - b[sortType];
            });

            // éå†æ¸²æŸ“
            sortedList.forEach((member, index) => {
                let nameHtml = hideSetting.hideName ? member.name : 'â€”â€”';
                let starHtml = hideSetting.hideStar ? `â­ ${member.star}` : '';
                let heartHtml = hideSetting.hideHeart ? `â¤ï¸ ${member.heart}` : '';
                let scoreHtml = (starHtml && heartHtml) ? `${starHtml} | ${heartHtml}` : starHtml || heartHtml;

                const item = document.createElement('div');
                item.className = 'rank-item';
                item.innerHTML = `
                    <div style="font-size: 20px; font-weight: bold; color: #${index<3 ? 'ffc107' : index<6 ? '6c757d' : '333'}; width: 35px;">${index+1}</div>
                    <img src="${member.photo}" alt="${member.name}" class="rank-avatar">
                    <div class="member-info">
                        <div style="font-size: 17px; font-weight: 500; color: #333; margin-bottom: 8px;">${nameHtml}</div>
                        <div style="font-size: 16px; color: #6c757d;">${scoreHtml}</div>
                    </div>
                `;
                rankContent.appendChild(item);
            });
        }

        /********************* éšè—è®¾ç½®ç›¸å…³ *********************/
        // ä¿å­˜éšè—è®¾ç½® - ç«‹å³åŒæ­¥æœ¬åœ°å­˜å‚¨
        function saveHideSetting() {
            hideSetting = {
                hideName: document.getElementById('hideName').checked,
                hideGender: document.getElementById('hideGender').checked,
                hideClass: document.getElementById('hideClass').checked,
                hideStar: document.getElementById('hideStar').checked,
                hideHeart: document.getElementById('hideHeart').checked
            };
            saveToLocal(); // ç«‹å³ä¿å­˜
            renderMemberList();
            renderRankList();
            document.getElementById('hideSettingModal').classList.remove('show');
            alert('âœ… æ˜¾ç¤ºè®¾ç½®ä¿å­˜æˆåŠŸï¼ï¼ˆå·²æ°¸ä¹…å­˜å‚¨ï¼‰');
        }
    </script>
</body>
</html>
